<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Karaoke Ng√¥i Sao Xanh ch∆°i h·∫øt m√¨nh</title>
<style>
/* --- Global --- */
body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  padding:0;
  background:#020617;
  color:#e5e7eb;
}
.container{
  max-width:1200px;
  margin:0 auto;
  padding:12px;
}
header{
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}
header h1{
  margin:0;
  font-size:20px;
}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  background:#111827;
  border:1px solid #4b5563;
  color:#9ca3af;
}
.layout{
  display:flex;
  flex-direction:column;
  gap:10px;
}
@media (min-width:900px){
  .layout{
    flex-direction:row;
    align-items:flex-start;
  }
}
.player-panel{
  flex:2;
}
.queue-panel{
  flex:1.2;
  max-height:560px;
  overflow-y:auto;
  background:#020617;
  border-radius:10px;
  border:1px solid #1f2937;
}
#player{
  width:100%;
  max-width:960px;
  aspect-ratio:16/9;
  background:#000;
  border-radius:8px;
  overflow:hidden;
}
.controls{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}
.btn{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #4b5563;
  background:#111827;
  color:#e5e7eb;
  cursor:pointer;
  font-size:13px;
}
.btn.primary{
  background:#22c55e;
  border-color:#22c55e;
  color:#022c22;
}
.btn.icon{
  padding:4px 6px;
  font-size:11px;
}
.btn:hover{
  filter:brightness(1.1);
}
.status-text{
  font-size:13px;
  color:#9ca3af;
}
.status-text span.now{
  color:#facc15;
}
.queue-header{
  position:sticky;
  top:0;
  z-index:1;
  background:#020617;
  border-bottom:1px solid #1f2937;
  padding:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.queue-title{
  font-size:14px;
  font-weight:600;
}
.queue-info{
  font-size:12px;
  color:#9ca3af;
}
.queue-list{
  list-style:none;
  margin:0;
  padding:0;
}
.queue-item{
  display:grid;
  grid-template-columns:auto 1fr;
  gap:6px;
  padding:8px;
  border-bottom:1px solid #111827;
  align-items:center;
}
.queue-item:nth-child(odd){
  background:#020617;
}
.queue-item:nth-child(even){
  background:#020617;
}
.queue-item.playing{
  background:#0f172a;
}
.queue-index{
  font-size:12px;
  color:#6b7280;
  width:26px;
  text-align:right;
}
.queue-main{
  min-width:0;
}
.queue-title-text{
  font-size:13px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.queue-meta{
  font-size:11px;
  color:#6b7280;
}
.badge-playing{
  display:inline-block;
  padding:1px 6px;
  font-size:10px;
  border-radius:999px;
  background:#22c55e;
  color:#022c22;
  margin-left:4px;
}
.badge-next{
  display:inline-block;
  padding:1px 6px;
  font-size:10px;
  border-radius:999px;
  background:#0ea5e9;
  color:#022c22;
  margin-left:4px;
}
.empty{
  padding:12px;
  font-size:13px;
  color:#6b7280;
}

/* N√∫t ƒëi·ªÅu khi·ªÉn t·ª´ admin */
.admin-control-btn{
  padding:4px 8px;
  border-radius:4px;
  border:1px solid #22c55e;
  background:#064e3b;
  color:#bbf7d0;
  font-size:11px;
  cursor:pointer;
  margin-left:6px;
}
.admin-control-btn:hover{
  filter:brightness(1.1);
}

/* --- Toast notification (g√≥c tr√™n ph·∫£i) --- */
.toast-notification {
  position: fixed;
  top: 18px;
  right: 18px;
  z-index: 9999;
  pointer-events: none; /* cho ph√©p click qua n·∫øu c·∫ßn */
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: calc(100% - 36px);
  min-width: 240px;
  box-sizing: border-box;
  border-radius: 12px;
  padding: 12px 14px;
  background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
  color: white;
  box-shadow: 0 10px 30px rgba(2,6,23,0.6), 0 4px 8px rgba(0,0,0,0.4);
  transform: translateX(110%); /* b·∫Øt ƒë·∫ßu ngo√†i khung ph·∫£i */
  opacity: 0;
  transition: transform 450ms cubic-bezier(.2,.8,.2,1), opacity 300ms ease;
  will-change: transform, opacity;
  pointer-events: auto; /* khi hi·ªán th√¨ gi·ªØ pointer */
}

/* khi active, slide v√†o */
.toast-notification.show {
  transform: translateX(0);
  opacity: 1;
}

/* icon circle v·ªõi pulse */
.toast-icon {
  flex: 0 0 44px;
  height: 44px;
  border-radius: 999px;
  background: rgba(255,255,255,0.12);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  box-shadow: 0 6px 18px rgba(3,105,161,0.35);
  position: relative;
  overflow: visible;
}

/* pulse effect */
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.18); }
  70% { box-shadow: 0 0 0 14px rgba(255,255,255,0.02); }
  100% { box-shadow: 0 0 0 0 rgba(255,255,255,0.0); }
}
.toast-icon.pulse::after {
  content: "";
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%);
  width: 100%;
  height: 100%;
  border-radius: 50%;
  pointer-events: none;
  animation: pulse 2s infinite;
}

/* n·ªôi dung text */
.toast-content {
  flex: 1 1 auto;
  min-width: 0;
}
.toast-title {
  font-weight:700;
  font-size:14px;
  line-height:1.1;
  margin:0 0 4px 0;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
}
.toast-sub {
  font-size:12px;
  opacity:0.92;
  margin:0;
}

/* small close button */
.toast-close {
  margin-left: 10px;
  background: transparent;
  border: none;
  color: rgba(255,255,255,0.95);
  font-size:16px;
  cursor:pointer;
  padding:6px;
  border-radius:6px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

/* Responsive adjustments */
@media (max-width:520px){
  .toast-notification {
    left: 12px;
    right: 12px;
    top: 12px;
    max-width: calc(100% - 24px);
    transform: translateY(-10px) scale(0.98);
  }
  .toast-notification.show {
    transform: translateY(0) scale(1);
  }
  .toast-icon { flex: 0 0 40px; height:40px; font-size:18px; }
  .toast-title { font-size:13px; }
  .toast-sub { font-size:12px; }
}

/* subtle small animation when showing the text */
@keyframes textPop {
  0% { transform: translateY(6px); opacity:0; }
  100% { transform: translateY(0); opacity:1; }
}
.toast-notification.show .toast-title,
.toast-notification.show .toast-sub {
  animation: textPop 380ms ease;
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Karaoke Ng√¥i Sao Xanh ch∆°i h·∫øt m√¨nh</h1>
      <div class="badge">Ch·∫ø ƒë·ªô xem & ph√°t nh·∫°c</div>
    </div>
    <div class="status-text" id="status">ƒêang kh·ªüi t·∫°o player...</div>
  </header>

  <div class="layout">
    <section class="player-panel">
      <div id="player"></div>
      <div class="controls">
        <button id="playpause" class="btn primary">‚èØ Play / Pause</button>
        <button id="btnNextPlayer" class="btn">‚ñ∂ B√†i ti·∫øp</button>
        <button id="fullscreen" class="btn icon">‚õ∂ To√†n m√†n h√¨nh</button>
      </div>
    </section>

    <aside class="queue-panel">
      <div class="queue-header">
        <div class="queue-title">Danh s√°ch s·∫Ω ph√°t</div>
        <div class="queue-info" id="queueInfo">0 b√†i</div>
      </div>
      <ul id="queueList" class="queue-list"></ul>
    </aside>
  </div>
</div>

<!-- Toast notification (DOM) -->
<div id="nextToast" class="toast-notification" role="status" aria-live="polite" aria-atomic="true" style="display:none;">
  <div class="toast-icon pulse" aria-hidden="true">üéµ</div>
  <div class="toast-content">
    <div class="toast-title" id="toastTitle">B√†i ti·∫øp theo</div>
    <div class="toast-sub" id="toastSub">S·∫Ω ph√°t sau 15 gi√¢y</div>
  </div>
  <button class="toast-close" id="toastClose" aria-label="ƒê√≥ng th√¥ng b√°o">‚úï</button>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBlj5BXufxS4lp4wdVgDKFAncbsUpqa-G8",
  authDomain: "thutuphat-c751f.firebaseapp.com",
  projectId: "thutuphat-c751f",
  storageBucket: "thutuphat-c751f.firebasestorage.app",
  messagingSenderId: "418283924180",
  appId: "1:418283924180:web:0814987f795cc10a362941",
  databaseURL: "https://thutuphat-c751f-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let ytPlayer;
let playingIndex = -1;
let queue = []; // {key, videoId, title, url, order, addedAt}

// For controlling toast show/hide logic
const TOAST_SHOW_SECONDS_REMAINING = 15; // show when <= 15s remaining
const TOAST_AUTO_HIDE_MS = 8000; // 8 seconds
let toastTimeout = null;
let toastHideTimeout = null;
let pollInterval = null;
let lastNotifiedNextIndex = null; // avoid duplicate notification for same next song during single play

// DOM refs
const toastEl = document.getElementById("nextToast");
const toastTitleEl = document.getElementById("toastTitle");
const toastSubEl = document.getElementById("toastSub");
const toastCloseBtn = document.getElementById("toastClose");

// --- YouTube Iframe API ---
function onYouTubeIframeAPIReady(){
  ytPlayer = new YT.Player("player", {
    height: "540",
    width: "960",
    videoId: "",
    playerVars: { playsinline: 1 },
    events: {
      onReady: () => {
        document.getElementById("status").textContent = "S·∫µn s√†ng. S·∫Ω t·ª± ƒë·ªông ph√°t theo danh s√°ch.";
        startPollingForRemainingTime();
      },
      onStateChange: onPlayerStateChange
    }
  });
}
window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

function onPlayerStateChange(e){
  if(e.data === YT.PlayerState.ENDED){
    // reset notify marker for the play that just ended
    lastNotifiedNextIndex = null;
    playNextAuto();
  } else if(e.data === YT.PlayerState.PLAYING) {
    // ensure polling checks remaining time
    startPollingForRemainingTime();
  } else if(e.data === YT.PlayerState.PAUSED) {
    // keep polling, but we won't show toast unless playing and remaining time counts down
  }
}

// --- Poll remaining time and decide when to show toast ---
function startPollingForRemainingTime(){
  if(pollInterval) return;
  pollInterval = setInterval(()=>{
    try {
      if(!ytPlayer || !queue || queue.length===0) return;
      const state = ytPlayer.getPlayerState();
      if(state !== YT.PlayerState.PLAYING && state !== YT.PlayerState.PAUSED) return;
      const duration = ytPlayer.getDuration();
      const current = ytPlayer.getCurrentTime();
      if(!isFinite(duration) || duration <= 0) return;
      const remaining = duration - current;
      // determine next index
      const nextIdx = (playingIndex + 1 < queue.length) ? playingIndex + 1 : (queue.length>0?0:-1);
      if(nextIdx < 0 || nextIdx >= queue.length) return;

      // show toast only when remaining <= threshold AND we have not shown for this nextIdx yet
      if(remaining <= TOAST_SHOW_SECONDS_REMAINING && remaining > 0){
        if(lastNotifiedNextIndex !== nextIdx){
          // show
          showNextToastForIndex(nextIdx, Math.ceil(remaining));
          lastNotifiedNextIndex = nextIdx;
        } else {
          // already shown for this nextIndex; do nothing
        }
      }
    } catch (err) {
      // ignore transient errors (player may not be ready)
      // console.warn("poll error", err);
    }
  }, 600); // check ~every 600ms
}

function stopPollingForRemainingTime(){
  if(pollInterval){
    clearInterval(pollInterval);
    pollInterval = null;
  }
}

// --- Toast show/hide functions ---
function showNextToastForIndex(nextIdx, secondsRemaining){
  const next = queue[nextIdx];
  if(!next) return;
  const title = next.title || next.url || next.videoId || "B√†i ti·∫øp theo";
  toastTitleEl.textContent = title;
  toastSubEl.textContent = `S·∫Ω ph√°t trong ${secondsRemaining} gi√¢y`;
  showToast();
}

function showToast(){
  clearTimeout(toastHideTimeout);
  // update DOM display
  toastEl.style.display = "flex";
  // small delay to allow display-> show class transition
  requestAnimationFrame(()=>{
    toastEl.classList.add("show");
  });
  // auto hide after TOAST_AUTO_HIDE_MS
  toastHideTimeout = setTimeout(()=>{ hideToast(); }, TOAST_AUTO_HIDE_MS);
}

function hideToast(){
  toastEl.classList.remove("show");
  // after transition, hide completely
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>{
    toastEl.style.display = "none";
  }, 480);
}

// allow manual close
toastCloseBtn.addEventListener("click", ()=>{
  hideToast();
  // ensure we don't re-show repeatedly for same next track within the same play
  // (we already set lastNotifiedNextIndex when showing)
});

// --- Playback control (ch·ªâ play/pause + t·ª± next) ---
function updateStatus(){
  const statusEl = document.getElementById("status");
  if(playingIndex < 0 || playingIndex >= queue.length){
    if(queue.length === 0){
      statusEl.textContent = "Danh s√°ch tr·ªëng. H√£y th√™m b√†i t·ª´ trang client.";
    }else{
      statusEl.textContent = "S·∫µn s√†ng. B√†i ƒë·∫ßu s·∫Ω ph√°t khi nh·∫•n play.";
    }
    return;
  }
  const v = queue[playingIndex];
  statusEl.innerHTML = 'ƒêang ph√°t: <span class="now">'+(v.title || v.videoId)+'</span>';
}

function playAt(index){
  if(index < 0 || index >= queue.length || !ytPlayer) return;
  playingIndex = index;
  const v = queue[index];
  ytPlayer.loadVideoById(v.videoId);
  // reset notification marker for new playing track
  lastNotifiedNextIndex = null;
  updateStatus();
  renderList();
}

function playNextAuto(){
  if(queue.length === 0) return;
  const nextIdx = (playingIndex + 1 < queue.length) ? playingIndex + 1 : 0;
  playAt(nextIdx);
}

let firstStart = false;

document.getElementById("playpause").addEventListener("click", ()=>{
  if(!ytPlayer){
    if(queue.length > 0){
      playAt(0);
    }
    return;
  }

  // L·∫ßn b·∫•m ƒë·∫ßu ti√™n: v·ª´a fullscreen v·ª´a ph√°t b√†i ƒë·∫ßu
  if(!firstStart){
    firstStart = true;
    const iframe = document.querySelector("#player iframe");
    try{
      if(iframe && iframe.requestFullscreen){
        iframe.requestFullscreen();
      }else if(iframe && iframe.webkitRequestFullscreen){
        iframe.webkitRequestFullscreen();
      }else if(iframe && iframe.msRequestFullscreen){
        iframe.msRequestFullscreen();
      }
    }catch(e){
      console.warn("Fullscreen request b·ªã ch·∫∑n:", e);
    }
    if(queue.length > 0){
      playAt(0);
    }else{
      ytPlayer.playVideo();
    }
    return;
  }

  const s = ytPlayer.getPlayerState();
  if(s === YT.PlayerState.PLAYING){
    ytPlayer.pauseVideo();
  }else if(s === YT.PlayerState.PAUSED || s === YT.PlayerState.CUED){
    ytPlayer.playVideo();
  }else if((s === -1 || s === YT.PlayerState.ENDED) && queue.length > 0){
    playAt(0);
  }else{
    ytPlayer.playVideo();
  }
});

// Fullscreen button (n·∫øu mu·ªën b·∫•m l·∫°i b·∫±ng tay)
document.getElementById("fullscreen").addEventListener("click", ()=>{
  const iframe = document.querySelector("#player iframe");
  if(iframe && iframe.requestFullscreen){
    iframe.requestFullscreen();
  }else if(iframe && iframe.webkitRequestFullscreen){
    iframe.webkitRequestFullscreen();
  }else if(iframe && iframe.msRequestFullscreen){
    iframe.msRequestFullscreen();
  }
});

// N√∫t "B√†i ti·∫øp" tr√™n player (skip ngay l·∫≠p t·ª©c)
document.getElementById("btnNextPlayer").addEventListener("click", ()=>{
  if(queue.length === 0) return;
  const nextIdx = (playingIndex + 1 < queue.length) ? playingIndex + 1 : 0;
  playAt(nextIdx);
});

// --- Queue rendering (ch·ªâ hi·ªÉn th·ªã, kh√¥ng c√≥ n√∫t x√≥a / reorder) ---
function renderList(){
  const listEl = document.getElementById("queueList");
  const infoEl = document.getElementById("queueInfo");
  listEl.innerHTML = "";

  infoEl.textContent = queue.length + " b√†i";

  if(queue.length === 0){
    const empty = document.createElement("div");
    empty.className = "empty";
    empty.textContent = "Ch∆∞a c√≥ b√†i trong danh s√°ch. H√£y d√πng trang client ƒë·ªÉ th√™m b√†i.";
    listEl.appendChild(empty);
    return;
  }

  queue.forEach((it, idx)=>{
    const li = document.createElement("li");
    li.className = "queue-item";
    if(idx === playingIndex){
      li.classList.add("playing");
    }

    const idxDiv = document.createElement("div");
    idxDiv.className = "queue-index";
    idxDiv.textContent = (idx+1).toString();

    const mainDiv = document.createElement("div");
    mainDiv.className = "queue-main";
    const titleSpan = document.createElement("div");
    titleSpan.className = "queue-title-text";
    titleSpan.textContent = it.title || it.url || it.videoId;
    const metaDiv = document.createElement("div");
    metaDiv.className = "queue-meta";
    let metaText = "ID: "+(it.videoId || "");
    if(it.addedAt){
      const d = new Date(it.addedAt);
      metaText += " ¬∑ " + d.toLocaleTimeString();
    }
    metaDiv.textContent = metaText;
    titleSpan.appendChild(document.createTextNode(" "));
    if(idx === playingIndex){
      const badge = document.createElement("span");
      badge.className = "badge-playing";
      badge.textContent = "ƒêang ph√°t";
      titleSpan.appendChild(badge);
    }else if(idx === playingIndex+1){
      const badgeN = document.createElement("span");
      badgeN.className = "badge-next";
      badgeN.textContent = "Ti·∫øp theo";
      titleSpan.appendChild(badgeN);
    }
    mainDiv.appendChild(titleSpan);
    mainDiv.appendChild(metaDiv);

    li.appendChild(idxDiv);
    li.appendChild(mainDiv);
    listEl.appendChild(li);
  });
}

// Listen to Firebase queue (ch·ªâ ƒë·ªçc)
db.ref("queue").orderByChild("order").on("value", snap=>{
  const obj = snap.val() || {};
  queue = Object.entries(obj).map(([k,v])=>{
    return {
      key: k,
      videoId: v.videoId,
      title: v.title || v.url,
      url: v.url,
      order: v.order || v.addedAt || 0,
      addedAt: v.addedAt || null
    };
  });
  queue.sort((a,b)=> (a.order||0) - (b.order||0));
  if(playingIndex >= queue.length){
    playingIndex = (queue.length > 0) ? 0 : -1;
  }
  renderList();
  updateStatus();
});

// Player nghe l·ªánh t·ª´ admin
const controlRef = db.ref("control");
controlRef.on("value", snap=>{
  const data = snap.val();
  if(!data) return;

  // Skip sang b√†i ti·∫øp
  if(data.action === "skip_next"){
    playNextAuto();
  }

  // Ph√°t b√†i c·ª• th·ªÉ do admin ch·ªçn
  if(data.action === "play_at_index"){
    const idx = typeof data.index === "number" ? data.index : parseInt(data.index, 10);
    if(!isNaN(idx) && idx >= 0 && idx < queue.length){
      playAt(idx);
    }
  }

  // Sau khi x·ª≠ l√Ω xong, x√≥a l·ªánh ƒë·ªÉ tr√°nh l·∫∑p l·∫°i
  controlRef.remove().catch(()=>{});
});

// Clean up when page unloads
window.addEventListener("beforeunload", ()=>{
  stopPollingForRemainingTime();
  if(toastHideTimeout) clearTimeout(toastHideTimeout);
  if(toastTimeout) clearTimeout(toastTimeout);
});
</script>
</body>
</html>
