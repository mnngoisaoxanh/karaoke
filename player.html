<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Karaoke Ngôi Sao Xanh chơi hết mình</title>
<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  padding:0;
  background:#020617;
  color:#e5e7eb;
}
.container{
  max-width:1200px;
  margin:0 auto;
  padding:12px;
}
header{
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}
header h1{
  margin:0;
  font-size:20px;
}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  background:#111827;
  border:1px solid #4b5563;
  color:#9ca3af;
}
.layout{
  display:flex;
  flex-direction:column;
  gap:10px;
}
@media (min-width:900px){
  .layout{
    flex-direction:row;
    align-items:flex-start;
  }
}
.player-panel{
  flex:2;
}
.queue-panel{
  flex:1.2;
  max-height:560px;
  overflow-y:auto;
  background:#020617;
  border-radius:10px;
  border:1px solid #1f2937;
}
#player{
  width:100%;
  max-width:960px;
  aspect-ratio:16/9;
  background:#000;
  border-radius:8px;
  overflow:hidden;
}
.controls{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}
.btn{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #4b5563;
  background:#111827;
  color:#e5e7eb;
  cursor:pointer;
  font-size:13px;
}
.btn.primary{
  background:#22c55e;
  border-color:#22c55e;
  color:#022c22;
}
.btn.icon{
  padding:4px 6px;
  font-size:11px;
}
.btn:hover{
  filter:brightness(1.1);
}
.status-text{
  font-size:13px;
  color:#9ca3af;
}
.status-text span.now{
  color:#facc15;
}
.queue-header{
  position:sticky;
  top:0;
  z-index:1;
  background:#020617;
  border-bottom:1px solid #1f2937;
  padding:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.queue-title{
  font-size:14px;
  font-weight:600;
}
.queue-info{
  font-size:12px;
  color:#9ca3af;
}
.queue-list{
  list-style:none;
  margin:0;
  padding:0;
}
.queue-item{
  display:grid;
  grid-template-columns:auto 1fr;
  gap:6px;
  padding:8px;
  border-bottom:1px solid #111827;
  align-items:center;
}
.queue-item:nth-child(odd){
  background:#020617;
}
.queue-item:nth-child(even){
  background:#020617;
}
.queue-item.playing{
  background:#0f172a;
}
.queue-index{
  font-size:12px;
  color:#6b7280;
  width:26px;
  text-align:right;
}
.queue-main{
  min-width:0;
}
.queue-title-text{
  font-size:13px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.queue-meta{
  font-size:11px;
  color:#6b7280;
}
.badge-playing{
  display:inline-block;
  padding:1px 6px;
  font-size:10px;
  border-radius:999px;
  background:#22c55e;
  color:#022c22;
  margin-left:4px;
}
.badge-next{
  display:inline-block;
  padding:1px 6px;
  font-size:10px;
  border-radius:999px;
  background:#0ea5e9;
  color:#022c22;
  margin-left:4px;
}
.empty{
  padding:12px;
  font-size:13px;
  color:#6b7280;
}

/* Nút điều khiển từ admin */
.admin-control-btn{
  padding:4px 8px;
  border-radius:4px;
  border:1px solid #22c55e;
  background:#064e3b;
  color:#bbf7d0;
  font-size:11px;
  cursor:pointer;
  margin-left:6px;
}
.admin-control-btn:hover{
  filter:brightness(1.1);
}

/* Container cho player - để chứa overlay fullscreen */
#playerWrapper {
  position: relative;
  width: 100%;
  max-width: 960px;
  aspect-ratio: 16/9;
}

/* Thông báo bài tiếp theo - hiển thị cả trong fullscreen */
.next-song-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
  color: #fff;
  padding: 16px 20px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(14, 165, 233, 0.4);
  z-index: 999999;
  min-width: 280px;
  max-width: 400px;
  opacity: 0;
  transform: translateX(120%);
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border: 2px solid rgba(255, 255, 255, 0.3);
  pointer-events: none;
}

/* Khi ở chế độ fullscreen */
.fullscreen-notification {
  position: absolute !important;
  top: 40px !important;
  right: 40px !important;
}

.next-song-notification.show {
  opacity: 1;
  transform: translateX(0);
}

.notification-header {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  opacity: 0.9;
  display: flex;
  align-items: center;
  gap: 6px;
}

.notification-title {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
  line-height: 1.4;
}

.notification-time {
  font-size: 11px;
  opacity: 0.8;
  display: flex;
  align-items: center;
  gap: 4px;
}

.pulse-icon {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: #fff;
  border-radius: 50%;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}

/* Responsive cho mobile */
@media (max-width: 600px) {
  .next-song-notification {
    top: 10px;
    right: 10px;
    left: 10px;
    min-width: auto;
    max-width: none;
  }
  
  .fullscreen-notification {
    top: 20px !important;
    right: 20px !important;
    left: 20px !important;
  }
}

/* Styling cho fullscreen */
#playerWrapper:-webkit-full-screen {
  width: 100%;
  height: 100%;
  background: #000;
}

#playerWrapper:-moz-full-screen {
  width: 100%;
  height: 100%;
  background: #000;
}

#playerWrapper:-ms-fullscreen {
  width: 100%;
  height: 100%;
  background: #000;
}

#playerWrapper:fullscreen {
  width: 100%;
  height: 100%;
  background: #000;
}

#playerWrapper:-webkit-full-screen #player {
  max-width: 100%;
  width: 100%;
  height: 100%;
}

#playerWrapper:-moz-full-screen #player {
  max-width: 100%;
  width: 100%;
  height: 100%;
}

#playerWrapper:-ms-fullscreen #player {
  max-width: 100%;
  width: 100%;
  height: 100%;
}

#playerWrapper:fullscreen #player {
  max-width: 100%;
  width: 100%;
  height: 100%;
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>

<!-- Thông báo bài tiếp theo -->
<div id="nextSongNotification" class="next-song-notification">
  <div class="notification-header">
    <span class="pulse-icon"></span>
    Tiếp theo
  </div>
  <div class="notification-title" id="notificationTitle">Tên bài hát</div>
  <div class="notification-time" id="notificationTime">⏱ Sẽ phát sau 15 giây</div>
</div>

<div class="container">
  <header>
    <div>
      <h1>Karaoke Ngôi Sao Xanh chơi hết mình</h1>
      <div class="badge">Chế độ xem & phát nhạc</div>
    </div>
    <div class="status-text" id="status">Đang khởi tạo player...</div>
  </header>

  <div class="layout">
    <section class="player-panel">
      <div id="playerWrapper">
        <div id="player"></div>
      </div>
      <div class="controls">
        <button id="playpause" class="btn primary">▶ Play / Pause</button>
        <button id="btnNextPlayer" class="btn">▶ Bài tiếp</button>
        <button id="fullscreen" class="btn icon">⛶ Toàn màn hình</button>
      </div>
    </section>

    <aside class="queue-panel">
      <div class="queue-header">
        <div class="queue-title">Danh sách sẽ phát</div>
        <div class="queue-info" id="queueInfo">0 bài</div>
      </div>
      <ul id="queueList" class="queue-list"></ul>
    </aside>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBlj5BXufxS4lp4wdVgDKFAncbsUpqa-G8",
  authDomain: "thutuphat-c751f.firebaseapp.com",
  projectId: "thutuphat-c751f",
  storageBucket: "thutuphat-c751f.firebasestorage.app",
  messagingSenderId: "418283924180",
  appId: "1:418283924180:web:0814987f795cc10a362941",
  databaseURL: "https://thutuphat-c751f-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let ytPlayer;
let playingIndex = -1;
let queue = []; // {key, videoId, title, url, order, addedAt}

// Lắng nghe tín hiệu điều khiển từ admin
const controlRef = db.ref("control");

// --- YouTube Iframe API ---
function onYouTubeIframeAPIReady(){
  ytPlayer = new YT.Player("player", {
    height: "540",
    width: "960",
    videoId: "",
    playerVars: { playsinline: 1 },
    events: {
      onReady: () => {
        document.getElementById("status").textContent = "Sẵn sàng. Sẽ tự động phát theo danh sách.";
      },
      onStateChange: onPlayerStateChange
    }
  });
}
window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

function onPlayerStateChange(e){
  if(e.data === YT.PlayerState.ENDED){
    playNextAuto();
  }
}

// --- Playback control (chỉ play/pause + tự next) ---
function updateStatus(){
  const statusEl = document.getElementById("status");
  if(playingIndex < 0 || playingIndex >= queue.length){
    if(queue.length === 0){
      statusEl.textContent = "Danh sách trống. Hãy thêm bài từ trang client.";
    }else{
      statusEl.textContent = "Sẵn sàng. Bài đầu sẽ phát khi nhấn play.";
    }
    return;
  }
  const v = queue[playingIndex];
  statusEl.innerHTML = 'Đang phát: <span class="now">'+(v.title || v.videoId)+'</span>';
}

function playAt(index){
  if(index < 0 || index >= queue.length || !ytPlayer) return;
  playingIndex = index;
  const v = queue[index];
  ytPlayer.loadVideoById(v.videoId);
  updateStatus();
  renderList();
}

function playNextAuto(){
  if(queue.length === 0) return;
  const nextIdx = (playingIndex + 1 < queue.length) ? playingIndex + 1 : 0;
  playAt(nextIdx);
}

let firstStart = false;

// Hàm xử lý fullscreen cho wrapper (không phải iframe)
function requestFullscreenWrapper() {
  const wrapper = document.getElementById("playerWrapper");
  
  // Di chuyển notification vào wrapper khi vào fullscreen
  const notification = document.getElementById("nextSongNotification");
  if (wrapper.contains(notification) === false) {
    wrapper.appendChild(notification);
  }
  notification.classList.add("fullscreen-notification");
  
  try {
    if (wrapper.requestFullscreen) {
      wrapper.requestFullscreen();
    } else if (wrapper.webkitRequestFullscreen) {
      wrapper.webkitRequestFullscreen();
    } else if (wrapper.msRequestFullscreen) {
      wrapper.msRequestFullscreen();
    } else if (wrapper.mozRequestFullScreen) {
      wrapper.mozRequestFullScreen();
    }
  } catch (e) {
    console.warn("Fullscreen request bị chặn:", e);
  }
}

// Lắng nghe sự kiện fullscreen change
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('MSFullscreenChange', handleFullscreenChange);

function handleFullscreenChange() {
  const notification = document.getElementById("nextSongNotification");
  const wrapper = document.getElementById("playerWrapper");
  
  const isFullscreen = !!(
    document.fullscreenElement ||
    document.webkitFullscreenElement ||
    document.mozFullScreenElement ||
    document.msFullscreenElement
  );
  
  if (isFullscreen) {
    // Đang ở chế độ fullscreen - di chuyển notification vào wrapper
    if (!wrapper.contains(notification)) {
      wrapper.appendChild(notification);
    }
    notification.classList.add("fullscreen-notification");
  } else {
    // Thoát fullscreen - di chuyển notification về body
    notification.classList.remove("fullscreen-notification");
    if (!document.body.contains(notification)) {
      document.body.insertBefore(notification, document.body.firstChild);
    }
  }
}

document.getElementById("playpause").addEventListener("click", ()=>{
  if(!ytPlayer){
    if(queue.length > 0){
      playAt(0);
    }
    return;
  }

  // Lần bấm đầu tiên: vừa fullscreen vừa phát bài đầu
  if(!firstStart){
    firstStart = true;
    requestFullscreenWrapper();
    if(queue.length > 0){
      playAt(0);
    }else{
      ytPlayer.playVideo();
    }
    return;
  }

  const s = ytPlayer.getPlayerState();
  if(s === YT.PlayerState.PLAYING){
    ytPlayer.pauseVideo();
  }else if(s === YT.PlayerState.PAUSED || s === YT.PlayerState.CUED){
    ytPlayer.playVideo();
  }else if((s === -1 || s === YT.PlayerState.ENDED) && queue.length > 0){
    playAt(0);
  }else{
    ytPlayer.playVideo();
  }
});

// Fullscreen button (nếu muốn bấm lại bằng tay)
document.getElementById("fullscreen").addEventListener("click", ()=>{
  requestFullscreenWrapper();
});

// Nút "Bài tiếp" trên player (skip ngay lập tức)
document.getElementById("btnNextPlayer").addEventListener("click", ()=>{
  if(queue.length === 0) return;
  const nextIdx = (playingIndex + 1 < queue.length) ? playingIndex + 1 : 0;
  playAt(nextIdx);
});

// --- Queue rendering (chỉ hiển thị, không có nút xóa / reorder) ---
function renderList(){
  const listEl = document.getElementById("queueList");
  const infoEl = document.getElementById("queueInfo");
  listEl.innerHTML = "";

  infoEl.textContent = queue.length + " bài";

  if(queue.length === 0){
    const empty = document.createElement("div");
    empty.className = "empty";
    empty.textContent = "Chưa có bài trong danh sách. Hãy dùng trang client để thêm bài.";
    listEl.appendChild(empty);
    return;
  }

  queue.forEach((it, idx)=>{
    const li = document.createElement("li");
    li.className = "queue-item";
    if(idx === playingIndex){
      li.classList.add("playing");
    }

    const idxDiv = document.createElement("div");
    idxDiv.className = "queue-index";
    idxDiv.textContent = (idx+1).toString();

    const mainDiv = document.createElement("div");
    mainDiv.className = "queue-main";
    const titleSpan = document.createElement("div");
    titleSpan.className = "queue-title-text";
    titleSpan.textContent = it.title || it.url || it.videoId;
    const metaDiv = document.createElement("div");
    metaDiv.className = "queue-meta";
    let metaText = "ID: "+(it.videoId || "");
    if(it.addedAt){
      const d = new Date(it.addedAt);
      metaText += " · " + d.toLocaleTimeString();
    }
    metaDiv.textContent = metaText;
    titleSpan.appendChild(document.createTextNode(" "));
    if(idx === playingIndex){
      const badge = document.createElement("span");
      badge.className = "badge-playing";
      badge.textContent = "Đang phát";
      titleSpan.appendChild(badge);
    }else if(idx === playingIndex+1){
      const badgeN = document.createElement("span");
      badgeN.className = "badge-next";
      badgeN.textContent = "Tiếp theo";
      titleSpan.appendChild(badgeN);
    }
    mainDiv.appendChild(titleSpan);
    mainDiv.appendChild(metaDiv);

    li.appendChild(idxDiv);
    li.appendChild(mainDiv);
    listEl.appendChild(li);
  });
}

// Listen to Firebase queue (chỉ đọc)
db.ref("queue").orderByChild("order").on("value", snap=>{
  const obj = snap.val() || {};
  queue = Object.entries(obj).map(([k,v])=>{
    return {
      key: k,
      videoId: v.videoId,
      title: v.title || v.url,
      url: v.url,
      order: v.order || v.addedAt || 0,
      addedAt: v.addedAt || null
    };
  });
  queue.sort((a,b)=> (a.order||0) - (b.order||0));
  if(playingIndex >= queue.length){
    playingIndex = (queue.length > 0) ? 0 : -1;
  }
  renderList();
  updateStatus();
});

// Player nghe lệnh từ admin
controlRef.on("value", snap=>{
  const data = snap.val();
  if(!data) return;

  // Skip sang bài tiếp
  if(data.action === "skip_next"){
    playNextAuto();
  }

  // Phát bài cụ thể do admin chọn
  if(data.action === "play_at_index"){
    const idx = typeof data.index === "number" ? data.index : parseInt(data.index, 10);
    if(!isNaN(idx) && idx >= 0 && idx < queue.length){
      playAt(idx);
    }
  }

  // Sau khi xử lý xong, xóa lệnh để tránh lặp lại
  controlRef.remove().catch(()=>{});
});

// --- Thông báo bài tiếp theo ---
let notificationTimeout = null;
let notificationCheckInterval = null;
let lastNotificationTime = 0;

function showNextSongNotification(nextSong, secondsLeft) {
  const notification = document.getElementById("nextSongNotification");
  const titleEl = document.getElementById("notificationTitle");
  const timeEl = document.getElementById("notificationTime");
  
  titleEl.textContent = nextSong.title || nextSong.videoId || "Bài tiếp theo";
  timeEl.textContent = `⏱ Sẽ phát sau ${secondsLeft} giây`;
  
  notification.classList.add("show");
  
  // Tự động ẩn sau 8 giây
  clearTimeout(notificationTimeout);
  notificationTimeout = setTimeout(() => {
    notification.classList.remove("show");
  }, 8000);
}

function checkAndShowNotification() {
  if (!ytPlayer || playingIndex < 0 || playingIndex >= queue.length) return;
  
  const nextIndex = playingIndex + 1;
  if (nextIndex >= queue.length) return; // Không có bài tiếp theo
  
  try {
    const currentTime = ytPlayer.getCurrentTime();
    const duration = ytPlayer.getDuration();
    const timeLeft = duration - currentTime;
    
    // Hiển thị thông báo khi còn 15 giây (chỉ hiển thị 1 lần)
    if (timeLeft <= 15 && timeLeft > 14 && Date.now() - lastNotificationTime > 20000) {
      const nextSong = queue[nextIndex];
      showNextSongNotification(nextSong, Math.floor(timeLeft));
      lastNotificationTime = Date.now();
    }
  } catch (e) {
    // Bỏ qua lỗi nếu player chưa sẵn sàng
  }
}

// Kiểm tra mỗi giây
notificationCheckInterval = setInterval(checkAndShowNotification, 1000);

// Khởi tạo: đảm bảo notification ở đúng vị trí ban đầu
window.addEventListener('DOMContentLoaded', () => {
  const notification = document.getElementById("nextSongNotification");
  if (!document.body.contains(notification)) {
    document.body.insertBefore(notification, document.body.firstChild);
  }
});
</script>
</body>
</html>
